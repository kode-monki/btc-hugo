{{ define "main" }}
  <section class="section">
  <div class="container">
    <h1 id="title" class="h2 mb-2">Loading...</h1>
    <p id="author" class="lead text-primary mb-8"></p>

    <div class="flex flex-wrap lg:flex-nowrap gap-8 mb-12 w-full" style="display: flex !important;">
      
  <div class="w-full" style="flex: 0 0 66% !important; max-width: 66%;">
    <div id="video-container" class="ratio ratio-16x9 bg-black rounded shadow-lg overflow-hidden" style="display: none; aspect-ratio: 16 / 9;">
      <iframe id="video-player" src="" allowfullscreen class="w-full h-full border-0"></iframe>
    </div>
  </div>

  <div class="w-full flex flex-col gap-6 p-6 bg-theme-light rounded-lg border border-border" 
       style="flex: 0 0 30% !important; max-width: 30%; height: fit-content;">
    
    <div>
      <h4 class="text-sm uppercase tracking-wider text-muted mb-2">Details</h4>
      <p class="mb-1">
  <strong>Author(s):</strong> 
  <a id="author-link" href="#" class="text-primary hover:underline">
    <span id="author-name"></span>
  </a>
</p>
<p class="mb-1"><strong>Year:</strong> <span id="year"></span></p>
      <div id="track-container">
        <strong>Tracks:</strong> <span id="track-list" class="flex flex-wrap gap-2 mt-2"></span>
      </div>
    </div>
    <br>
    <hr class="border-border">

    <div>
      <h4 class="text-sm uppercase tracking-wider text-muted mb-4">Resources</h4>
      <div class="flex flex-row gap-3 w-full" style="display: flex !important; flex-direction: row !important;">
        <a id="btn-slides" href="#" target="_blank" class="btn btn-outline-primary hidden flex-1 text-center py-2 px-1 text-sm whitespace-nowrap" style="width: 48%;">
          <i class="fas fa-file-powerpoint mr-1"></i> Slides 
        </a>&nbsp;&nbsp;
        <a id="btn-paper" href="#" target="_blank" class="btn btn-outline-primary hidden flex-1 text-center py-2 px-1 text-sm whitespace-nowrap" style="width: 48%;">
          <i class="fas fa-file-pdf mr-1"></i> Paper
        </a>
      </div>
    </div>
  </div>

</div>

    <div class="border-t border-border pt-8">
      <h3 class="h4 mb-4">Abstract</h3>
      <div id="abstract" class="content leading-relaxed text-lg"></div>
    </div>
  </div>
</section>

<script>

    const urlParams = new URLSearchParams(window.location.search);
    const paperId = urlParams.get('id')?.trim().toLowerCase();
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSmlApPlHI0wZmDVfFQiOq4lA4OJVICOPwYB3lyK0WX9PKmvKaX-kiNUULlAxM07cu4QlwrYZzeFc9V/pub?gid=0&single=true&output=csv";

    console.log("Searching for Paper ID:", paperId);

    fetch(sheetUrl)
      .then(response => response.text())
      .then(csvText => {
          // Use a simple regex to split rows while respecting quotes (common in titles)
          const rows = csvText.split(/\r?\n/).map(row => {
              return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, ''));
          });


console.log("First row of data (Headers):", rows[0]);
console.log("Sample cell from Column M (Index 12):", rows[1][12]);

          console.log("Sheet loaded. Total rows:", rows.length);

          // Find the paper where Col M (Index 12) matches our ID
          const paper = rows.find(r => r[12] && r[12].trim().toLowerCase() === paperId);

          if (paper) {
              console.log("Match found!", paper);
              document.getElementById('title').innerText = paper[2];    // Col C
              document.getElementById('author').innerText = paper[5];   // Col F
              document.getElementById('year').innerText = paper[1];     // Col B
              const authorName = paper[5];     // Col F
              const authorId = paper[22]?.trim(); // Col W
             // document.getElementById('track').innerText = paper[18];    // Col S


             // Update Author Name and Link
    const authorNameEl = document.getElementById('author-name');
    const authorLinkEl = document.getElementById('author-link');
    
    if (authorNameEl) authorNameEl.innerText = authorName;
    
    if (authorLinkEl && authorId) {
        authorLinkEl.href = `/authors/${authorId.toLowerCase()}/`;
    } else if (authorLinkEl) {
        // If no ID exists, remove the link styling/functionality
        authorLinkEl.style.pointerEvents = 'none';
        authorLinkEl.style.color = 'inherit';
        authorLinkEl.style.textDecoration = 'none';
    }

            // --- TRACK LOGIC ---
    const trackList = document.getElementById('track-list');
    const tracks = paper[18]?.split('|') || []; // Assuming Col H (Index 7)
    trackList.innerHTML = ''; // Clear "Loading"
    tracks.forEach(t => {
        if(t.trim()) {
            const span = document.createElement('span');
            span.className = "px-2 py-1 bg-primary/10 text-primary text-xs rounded-full border border-primary/20";
            span.innerText = t.trim();
            trackList.appendChild(span);
        }
    });




              // Video Handling (Col E - Index 4)
              const videoUrl = paper[4]?.trim();
              if (videoUrl) {
                  const videoId = extractYouTubeId(videoUrl);
                  if (videoId) {
                      document.getElementById('video-player').src = `https://www.youtube.com/embed/${videoId}`;
                      document.getElementById('video-container').style.display = 'block';
                  }
              }

              // For Slides
const slidesBtn = document.getElementById('btn-slides');
const slidesUrl = paper[8]?.trim();
if (slidesBtn && slidesUrl?.startsWith('http')) {
    slidesBtn.href = slidesUrl;
    // We remove the 'hidden' class AND force display to 'flex'
    slidesBtn.classList.remove('hidden');
    slidesBtn.style.setProperty('display', 'inline-flex', 'important');
}

// For Paper
const paperBtn = document.getElementById('btn-paper');
const paperUrl = paper[9]?.trim();
if (paperBtn && paperUrl?.startsWith('http')) {
    paperBtn.href = paperUrl;
    // We remove the 'hidden' class AND force display to 'flex'
    paperBtn.classList.remove('hidden');
    paperBtn.style.setProperty('display', 'inline-flex', 'important');
}

              // If you have an abstract in Col E (Index e):
              if(paper[3]) document.getElementById('abstract').innerHTML = paper[3];
          } else {
              console.log("No match found in the CSV rows.");
              document.getElementById('title').innerText = "Presentation Not Found";
              document.getElementById('author').innerText = "We couldn't find a paper matching that ID.";
          }
      })
      .catch(err => {
          console.error("Fetch error:", err);
          document.getElementById('title').innerText = "Error loading data";
      });

      // Helper function to turn any YouTube link into just the ID
function extractYouTubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

// Function to show buttons as flex items
function showButton(id, url) {
    const btn = document.getElementById(id);
    if (btn && url && url.startsWith('http')) {
        btn.href = url;
        btn.style.setProperty('display', 'inline-flex', 'important');
        btn.classList.remove('hidden');
    }
}

showButton('btn-slides', paper[8]);
showButton('btn-paper', paper[9]);
  </script>
  
{{ end }}